<launch>

    <!-- Arguments -->
    
    <!-- pub_lidar_tf - if to publish static transform from left camera to lidar -->
    <arg name="pub_lidar_tf" default="false"/>
    <node if="$(arg pub_lidar_tf)" pkg="tf2_ros" type="static_transform_publisher" name="zed_left_camera_optical_frame_to_velodyne_transform"
        args="4.632155672047202216e-02 -1.327858803524132048e-01 -6.092748914769485769e-02 -2.109805266472031704e+00 -1.588226287078796428e+00 -2.618237322666464806e+00 zed_left_camera_optical_frame velodyne"/>
    
    <!-- load_db - if load database -->
    <arg name="load_db" default="false"/>
    <arg if="$(arg load_db)" name="rtabmap_args" value=""/>
    <arg unless="$(arg load_db)" name="rtabmap_args" value="--delete_db_on_start"/>
    
    <!-- db_path - path to database -->
    <arg name="db_path" default="~/.ros/rtabmap.db"/>
    
    <!-- openvslam_drift - OpenVSLAM odometry drift factor -->
    <arg name="openvslam_drift" default="0"/> <!-- 0.005 -->
    
    <!-- odom - odometry to use -->
    <arg name="odom" default="openvslam"/>
    <!-- Custom node to convert OpenVSLAM odometry from camera frame to base_link -->
    <node if="$(eval odom == 'openvslam')" pkg="occupancy_grid_utils" type="transform_odometry.py" name="transfoem_odometry" output="screen"
        args="--in-odom-topic /OpenVSLAM/odom \
              --from-frame zed_left_camera_optical_frame \
              --to-frame base_link \
              --odom-frame odom \
              --out-odom-topic /OpenVSLAM/odom_base_link \
              --publish-odom-tf \
              --drift-factor $(arg openvslam_drift)"/>
        
    <arg if="$(eval odom == 'openvslam')" name="odom_topic" value="/OpenVSLAM/odom_base_link"/>
    <arg if="$(eval odom == 'rtabmap')" name="odom_topic" value="odom"/>
    
    <!-- local - localization mode, otherwise mapping mode -->
    <arg name="local" default="false"/>
    
    <!-- data to read -->
    <arg name="rgb" default="true"/>
    <arg name="depth" default="true"/>

    <!-- Rtabmap -->
    <node pkg="rtabmap_ros" type="rtabmap" name="rtabmap" ns="rtabmap" output="screen" args="$(arg rtabmap_args)">
        <!-- remap топиков для чтения данных -->
        <remap from="odom" to="$(arg odom_topic)"/>

        <remap from="left/image_rect" to="/zed_node/left/image_rect_color"/>
        <remap from="left/camera_info" to="/zed_node/left/camera_info"/>
        <remap from="right/image_rect" to="/zed_node/right/image_rect_color"/>
        <remap from="right/camera_info" to="/zed_node/right/camera_info"/>
        
        <remap from="scan_cloud" to="/velodyne_points"/>
        
        <remap from="rgb/image" to="/zed_node/left/image_rect_color"/>
        <remap from="rgb/camera_info" to="/zed_node/left/camera_info"/>
        <remap from="depth/image" to="/zed_node/depth/depth_registered"/>

        <!-- Данные, на которые подписывается rtabmap -->
        <param name="subscribe_rgb" value="$(arg rgb)"/>
        <param name="subscribe_stereo" value="false"/>
        <param name="subscribe_depth" value="$(arg depth)"/>
        <param name="subscribe_rgbd" value="false"/>
        <param name="subscribe_scan" value="false"/>
        <param name="subscribe_scan_cloud" value="true"/>
        
        <!-- Путь к database -->
        <param name="database_path" value="$(arg db_path)"/>
        
        <!-- Параметры синхронизации сообщений -->
        <param name="approx_sync" value="true"/>
        <param name="queue_size" value="10"/>
        
        <!-- Режим локализации или картирования -->
        <param if="$(arg local)" name="Mem/IncrementalMemory" value="false"/>
        <param unless="$(arg local)" name="Mem/IncrementalMemory" value="true"/>
        
        <!-- Параметры rtabmap -->
        <param name="Rtabmap/DetectionRate" value="100"/>
        <param name="Grid/RayTracing" value="true"/>
        <param name="Grid/FromDepth" value="false"/>
        <param name="Grid/MaxObstacleHeight" value="1.5"/>
        <param name="Grid/MaxGroundHeight" value="0.01"/> <!-- Должно быть отлично от нуля -->
        <param name="Grid/3D" value="false"/>
    </node>

</launch>

